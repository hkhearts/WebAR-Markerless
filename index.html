<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Modern Markerless AR with Animation</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>

<body>
  <script>
    // We bundle your logic into a single modern A-Frame component
    AFRAME.registerComponent('ar-logic', {
      init: function () {
        this.hud = document.querySelector("#hud");
        this.circle = document.querySelector("#circle");
        this.box = document.querySelector("#box");

        this.showMessage('AR Ready. Scanning for floor...');

        // In WebXR, 'select' replaces 'touchstart' for screen taps
        this.el.sceneEl.addEventListener('select', () => {
          // Only move the box if the circle (reticle) is currently visible on a surface
          if (this.circle.getAttribute('visible')) {
            let posCircle = this.circle.getAttribute('position');
            let posBox = this.box.getAttribute('position');
            
            // Format the target coordinates
            let position_string = `${posCircle.x.toFixed(2)} ${posCircle.y.toFixed(2)} ${posCircle.z.toFixed(2)}`;

            // Remove the old animation first (so you can tap multiple times in a row)
            this.box.removeAttribute('animation');

            // Apply the new animation to glide the box to the reticle
            this.box.setAttribute('animation', `property: position; to: ${position_string}; dur: 1000; easing: easeOutQuad;`);
          }
        });
      },

      tick: function () {
        // Instead of raycasting manually, we just check where the ar-hit-test put the circle
        if (this.circle && this.circle.getAttribute('visible')) {
          let pos = this.circle.getAttribute('position');
          this.showMessage(`Collision Detected!! ${pos.x.toFixed(2)} ${pos.z.toFixed(2)}`);
        } else {
          this.showMessage('Scanning for flat surface...');
        }
      },

      // Helper function to update HUD
      showMessage: function (message) {
        if (this.hud) {
          this.hud.setAttribute('value', message);
        }
      }
    });
  </script>

  <a-scene webxr="requiredFeatures: hit-test, local-floor;" ar-logic renderer="logarithmicDepthBuffer: true;">
    
    <a-camera id="cam" position="0 1.6 0">
      <a-text id="hud" 
        value="Loading..." 
        position="0 -0.1 -0.25"
        align="center"
        wrap-count="800"
        color="white">
      </a-text>
    </a-camera>

    <a-ring
      id="circle"
      ar-hit-test
      rotation="-90 0 0"
      radius-inner="0.02"
      radius-outer="0.04"
      color="teal">
    </a-ring>

    <a-box id="box" position="0 0 -1" color="red" scale="0.2 0.2 0.2"></a-box>

  </a-scene>
</body>
</html>