<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Markerless AR</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <script src="./aframe-ar-main/dist/aframe-ar.min.js"></script>
</head>

<body>
  <script>
    // Function to update the text on the screen
    function showMessage(message){
        let hud = document.querySelector("#hud");
        if(hud){
          hud.setAttribute('value', message);
        }
    }

    // Custom Component to handle AR tracking logic
    AFRAME.registerComponent('ar-logic', {
      init : function(){
        showMessage('ar-logic running');
      },

      tick : function(){
        let cam = document.querySelector("#cam");
        
        // Ensure the camera and the AR raycaster exist before proceeding
        if(!cam || !cam.components['ar-raycaster']){ return; }

        // Get intersection with the real-world AR surfaces (Not the virtual ring)
        let intersection = cam.components['ar-raycaster'].getIntersection();
        if(!intersection){ return; }

        // Output the raw X, Y, Z coordinates to the HUD
        showMessage(
          intersection.point.x.toFixed(2) + " " + 
          intersection.point.y.toFixed(2) + " " + 
          intersection.point.z.toFixed(2)
        );

        // Move the target (ring) to the real-world surface intersection point
        let target = document.querySelector("#target");
        target.setAttribute('position', intersection.point);
      }
    });

    // Handle screen taps to move the box
    window.addEventListener('touchstart', function(){
      let box = document.querySelector("#box");
      let target = document.querySelector("#target"); // Instructor uses "target"

      let posTarget = target.object3D.position;
      let posBox = box.object3D.position;

      // Calculate distance between current box position and the target location
      let distance = posBox.distanceTo(posTarget);

      let position_string = `${posTarget.x.toFixed(2)} ${posTarget.y.toFixed(2)} ${posTarget.z.toFixed(2)}`;
      
      // Calculate a dynamic duration so the movement speed is consistent
      // The instructor multiplies by 500 (or 700) to adjust the speed
      let dynamicDuration = Math.round(distance * 500); 

      // Apply the animation to the box
      box.setAttribute('animation', 
        `property: position; to: ${position_string}; dur: ${dynamicDuration};`
      );
    });
  </script>

  <a-scene ar ar-logic>
    <a-camera id="cam" ar-raycaster raycaster="objects: none;">
      <a-text id="hud" 
        value="Loading..." 
        position="0 -0.1 -0.25"
        align="center"
        wrap-count="800"
      ></a-text>
    </a-camera>

    <a-ring
      id="target"
      rotation="-90 0 0"
      radius-inner="0.01"
      radius-outer="0.02"
      color="white">
    </a-ring>

    <a-box id="box" position="0 0 -1" color="red" scale="0.2 0.2 0.2"></a-box>

  </a-scene>
</body>
</html>