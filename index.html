<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Modern Markerless AR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>

<body>
  <script>
    AFRAME.registerComponent('ar-logic', {
      init: function () {
        this.hud = document.querySelector("#hud");
        this.circle = document.querySelector("#circle");
        this.box = document.querySelector("#box");

        // Listen for screen taps
        this.el.sceneEl.addEventListener('select', () => {
          
          // CORRECT VISIBILITY CHECK: Check the raw 3D engine, not the HTML attribute
          if (this.circle.object3D.visible) {
            
            // 1. Get the exact position of the ring
            let pos = this.circle.object3D.position;
            
            // 2. Move the box! We add 0.05 to the Y-axis (half of its 0.1 scale)
            // so it sits perfectly ON the floor, instead of halfway inside it.
            this.box.object3D.position.set(pos.x, pos.y + 0.05, pos.z);
            
            // 3. Make the box visible
            this.box.setAttribute('visible', true);

            this.showMessage('Box placed! Tap elsewhere to move it.');
          }
        });
      },

      tick: function () {
        // Update the HUD based on whether the camera currently sees a surface
        if (this.circle && this.circle.object3D.visible) {
          if (this.box.getAttribute('visible') === false) {
             this.showMessage('Surface found! Tap screen to place the cube.');
          }
        } else {
          if (this.box.getAttribute('visible') === false) {
             this.showMessage('Scanning room... Move camera slowly.');
          }
        }
      },

      // Helper function to update the text on the screen
      showMessage: function (message) {
        if (this.hud) {
          this.hud.setAttribute('value', message);
        }
      }
    });
  </script>

  <a-scene webxr="requiredFeatures: hit-test, local-floor;" ar-logic renderer="logarithmicDepthBuffer: true;">
    
    <a-camera id="cam" position="0 1.6 0">
      <a-text id="hud" 
        value="Loading..." 
        position="0 -0.1 -0.25"
        align="center"
        wrap-count="800"
        color="white">
      </a-text>
    </a-camera>

    <a-ring
      id="circle"
      ar-hit-test
      rotation="-90 0 0"
      radius-inner="0.02"
      radius-outer="0.04"
      color="teal">
    </a-ring>

    <a-box id="box" visible="false" color="red" scale="0.1 0.1 0.1"></a-box>

  </a-scene>
</body>
</html>