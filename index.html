<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Modern Markerless AR - Place & Pick Up Object</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>

<body>
  <script>
    AFRAME.registerComponent('ar-logic', {
      init: function () {
        this.hud = document.querySelector("#hud");
        this.circle = document.querySelector("#circle");
        this.box = document.querySelector("#box");
        
        // Track whether the box is currently anchored to the real world
        this.isPlaced = false;

        this.showMessage('AR Ready. Scanning for surface...');

        // Listen for screen taps
        this.el.sceneEl.addEventListener('select', () => {
          // Only allow placing/picking up if the ring is currently detecting a surface
          if (this.circle.getAttribute('visible')) {
            
            // Toggle the placed state (true becomes false, false becomes true)
            this.isPlaced = !this.isPlaced; 
            
            if (this.isPlaced) {
              this.showMessage('Box placed! Tap again to pick it up.');
            } else {
              this.showMessage('Box picked up. Find a new spot!');
            }
          }
        });
      },

      tick: function () {
        // Check if the hit-test is currently finding a surface
        if (this.circle && this.circle.getAttribute('visible')) {
          let pos = this.circle.getAttribute('position');
          
          // If we are currently holding the box (not placed)
          if (!this.isPlaced) {
            this.box.setAttribute('position', pos);
            this.box.setAttribute('visible', true); // Ensure it's visible while tracking
            this.showMessage(`Previewing at: ${pos.x.toFixed(2)} ${pos.z.toFixed(2)}`);
          }
        } else {
          // If the camera loses track of the surface while holding the box
          if (!this.isPlaced) {
            this.showMessage('Scanning for flat surface...');
            this.box.setAttribute('visible', false); // Hide the box so it doesn't float in mid-air
          }
        }
      },

      // Helper function to update the text on the screen
      showMessage: function (message) {
        if (this.hud) {
          this.hud.setAttribute('value', message);
        }
      }
    });
  </script>

  <a-scene webxr="requiredFeatures: hit-test, local-floor;" ar-logic renderer="logarithmicDepthBuffer: true;">
    
    <a-camera id="cam" position="0 1.6 0">
      <a-text id="hud" 
        value="Loading..." 
        position="0 -0.1 -0.25"
        align="center"
        wrap-count="800"
        color="white">
      </a-text>
    </a-camera>

    <a-ring
      id="circle"
      ar-hit-test
      rotation="-90 0 0"
      radius-inner="0.02"
      radius-outer="0.04"
      color="teal">
    </a-ring>

    <a-box id="box" visible="false" color="red" scale="0.1 0.1 0.1"></a-box>

  </a-scene>
</body>
</html>